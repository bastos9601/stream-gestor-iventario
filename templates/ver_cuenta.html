{% extends "base.html" %}

{% block title %}Detalles de la Cuenta - Gestor de Cuentas de Streaming{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-eye me-2"></i>
                    Detalles de la Cuenta
                </h1>
                <p class="lead text-muted">Información completa de la cuenta seleccionada</p>
            </div>
            <div class="btn-group" role="group">
                <a href="{{ url_for('cuentas') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </a>
                <a href="{{ url_for('editar_cuenta', id=cuenta.id) }}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>Editar
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Información de la Cuenta - Sección Principal -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Información de la Cuenta
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Columna Izquierda -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-tv me-2"></i>Plataforma
                            </label>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary fs-6">{{ cuenta.plataforma }}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-envelope me-2"></i>Email
                            </label>
                            <div class="d-flex align-items-center">
                                <code class="text-danger fs-6">{{ cuenta.email }}</code>
                                <button class="btn btn-sm btn-outline-primary ms-2" 
                                        onclick="copyToClipboard('{{ cuenta.email }}')"
                                        title="Copiar email">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-dollar-sign me-2"></i>Precio
                            </label>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success fs-5">${{ "%.2f"|format(cuenta.precio) if cuenta.precio else '0.00' }}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-hashtag me-2"></i>ID de la Cuenta
                            </label>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary fs-6">#{{ cuenta.id }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-check-circle me-2"></i>Estado
                            </label>
                            <div class="d-flex align-items-center">
                                {% if cuenta.estado == 'Disponible' %}
                                    <span class="badge bg-success fs-6">
                                        <i class="fas fa-check me-1"></i>Disponible
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning fs-6">
                                        <i class="fas fa-dollar-sign me-1"></i>Vendida
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-lock me-2"></i>Contraseña
                            </label>
                            <div class="d-flex align-items-center">
                                <code class="fs-6" id="passwordDisplay">••••••••••</code>
                                <button class="btn btn-sm btn-outline-primary ms-2" 
                                        onclick="togglePassword()"
                                        title="Mostrar contraseña">
                                    <i class="fas fa-eye" id="eyeIcon"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary ms-2" 
                                        onclick="copyToClipboard('{{ cuenta.password }}')"
                                        title="Copiar contraseña">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar me-2"></i>Fecha de Compra
                            </label>
                            <div class="d-flex align-items-center">
                                <span>{{ cuenta.fecha_compra.strftime('%d/%m/%Y') if cuenta.fecha_compra else 'N/A' }}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-clock me-2"></i>Fecha de Creación
                            </label>
                            <div class="d-flex align-items-center">
                                <span>{{ cuenta.fecha_creacion.strftime('%d/%m/%Y %H:%M') if cuenta.fecha_creacion else 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Notas Adicionales -->
                {% if cuenta.notas %}
                <div class="row mt-3">
                    <div class="col-12">
                        <label class="form-label fw-bold">
                            <i class="fas fa-sticky-note me-2"></i>Notas Adicionales
                        </label>
                        <div class="p-3 bg-light rounded">
                            {{ cuenta.notas }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Columna Derecha - Acciones e Información Rápida -->
    <div class="col-lg-4">
        <!-- Acciones -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Acciones
                </h6>
            </div>
            <div class="card-body">
                {% if cuenta.estado == 'Vendida' %}
                    <!-- Información del Comprador cuando la cuenta está vendida -->
                    <div class="mb-3">
                        <h6 class="text-dark mb-2">Información del Comprador:</h6>
                        <div class="bg-light p-3 rounded">
                            <div class="mb-2">
                                <strong>Nombre:</strong> {{ cuenta.nombre_comprador if cuenta.nombre_comprador else 'N/A' }}
                            </div>
                            <div class="mb-2">
                                <strong>WhatsApp:</strong> {{ cuenta.whatsapp_comprador if cuenta.whatsapp_comprador else 'N/A' }}
                            </div>
                            <div class="mb-2">
                                <strong>Vencimiento:</strong> {{ cuenta.fecha_vencimiento.strftime('%d/%m/%Y') if cuenta.fecha_vencimiento else 'N/A' }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acción para cuentas vendidas -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="copiarMensajeWhatsApp()">
                            <i class="fas fa-copy me-2"></i>Copiar Mensaje WhatsApp
                        </button>
                        <button type="button" class="btn btn-success" onclick="enviarWhatsAppComprador()">
                            <i class="fab fa-whatsapp me-2"></i>Enviar a WhatsApp
                        </button>
                        <button type="button" class="btn btn-warning" onclick="recordarVencimiento()">
                            <i class="fas fa-clock me-2"></i>Recordar Vencimiento
                        </button>
                        <a href="{{ url_for('editar_cuenta', id=cuenta.id) }}" class="btn btn-warning">
                            <i class="fas fa-edit me-2"></i>Editar Cuenta
                        </a>
                        <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">
                            <i class="fas fa-trash me-2"></i>Eliminar Cuenta
                        </button>
                    </div>
                {% else %}
                    <!-- Botones de acción para cuentas disponibles -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="abrirModalVenta()">
                            <i class="fas fa-dollar-sign me-2"></i>Marcar como Vendida
                        </button>
                        <a href="{{ url_for('editar_cuenta', id=cuenta.id) }}" class="btn btn-warning">
                            <i class="fas fa-edit me-2"></i>Editar Cuenta
                        </a>
                        <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">
                            <i class="fas fa-trash me-2"></i>Eliminar Cuenta
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Información Rápida -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Información Rápida
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ "%.1f"|format(cuenta.precio) if cuenta.precio else '0.0' }}</h4>
                        <small class="text-muted">Precio</small>
                    </div>
                    <div class="col-6">
                        {% if cuenta.estado == 'Vendida' %}
                            <h4 class="text-warning">Vendida</h4>
                        {% elif cuenta.estado == 'Disponible' %}
                            <h4 class="text-success">Disponible</h4>
                        {% else %}
                            <h4 class="text-secondary">{{ cuenta.estado|title }}</h4>
                        {% endif %}
                        <small class="text-muted">Estado</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Acciones Relacionadas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-link me-2"></i>
                    Acciones Relacionadas
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <a href="{{ url_for('cuentas', plataforma=cuenta.plataforma) }}" 
                           class="btn btn-outline-primary w-100">
                            <i class="fas fa-tv me-2"></i>
                            Ver más cuentas de {{ cuenta.plataforma }}
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('cuentas', estado='Disponible') }}" 
                           class="btn btn-outline-primary w-100">
                            <i class="fas fa-arrow-down me-2"></i>
                            Ver cuentas disponibles
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('nueva_cuenta') }}" 
                           class="btn btn-outline-success w-100">
                            <i class="fas fa-plus me-2"></i>
                            Agregar nueva cuenta
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Marcar como Vendida - PERSONALIZADO -->
<div id="modalVenta" class="modal-personalizado" style="display: none;">
    <div class="modal-overlay" onclick="cerrarModal()"></div>
    <div class="modal-contenido">
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="fas fa-dollar-sign me-2"></i>
                Vender Cuenta
            </h5>
            <button type="button" class="btn-cerrar" onclick="cerrarModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('vender_cuenta', id=cuenta.id) }}" id="formVenta">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="nombre_comprador" class="form-label fw-bold">
                                <i class="fas fa-user me-2 text-primary"></i>
                                Nombre del Comprador *
                            </label>
                            <input type="text" class="form-control form-control-lg" 
                                   id="nombre_comprador" name="nombre_comprador" 
                                   required placeholder="Ingresa el nombre completo"
                                   autocomplete="off">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="whatsapp_comprador" class="form-label fw-bold">
                                <i class="fab fa-whatsapp me-2 text-success"></i>
                                Número de WhatsApp *
                            </label>
                            <input type="tel" class="form-control form-control-lg" 
                                   id="whatsapp_comprador" name="whatsapp_comprador" 
                                   required placeholder="+34612345678"
                                   autocomplete="off">
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Incluye el código del país
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="fecha_vencimiento" class="form-label fw-bold">
                        <i class="fas fa-calendar-alt me-2 text-warning"></i>
                        Fecha de Vencimiento *
                    </label>
                    <input type="date" class="form-control form-control-lg" 
                           id="fecha_vencimiento" name="fecha_vencimiento" 
                           required>
                    <div class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        La cuenta debe vencer después de la fecha de compra
                    </div>
                </div>
                
                <div class="alert alert-info border-0">
                    <div class="row">
                        <div class="col-md-4">
                            <strong><i class="fas fa-tv me-2"></i>Plataforma:</strong><br>
                            <span class="badge bg-primary fs-6">{{ cuenta.plataforma }}</span>
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-envelope me-2"></i>Email:</strong><br>
                            <code class="fs-6">{{ cuenta.email }}</code>
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-calendar me-2"></i>Fecha de Creación:</strong><br>
                            <span class="badge bg-info fs-6">{{ cuenta.fecha_creacion.strftime('%d/%m/%Y') if cuenta.fecha_creacion else 'N/A' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-lg" onclick="cerrarModal()">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-whatsapp btn-lg me-2" onclick="enviarWhatsApp()">
                    <i class="fab fa-whatsapp me-2"></i>
                    Enviar a WhatsApp
                </button>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-check me-2"></i>
                    Confirmar Venta
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Formulario oculto para eliminar cuenta -->
<form id="formEliminar" action="{{ url_for('eliminar_cuenta', id=cuenta.id) }}" method="POST" style="display: none;"></form>
{% endblock %}

{% block scripts %}
<style>
/* CSS para Modal Personalizado */
.modal-personalizado {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1;
}

.modal-contenido {
    position: relative;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 2;
}

.modal-header {
    background-color: #198754;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.btn-cerrar {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-cerrar:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

/* Botón de WhatsApp */
.btn-whatsapp {
    background-color: #25d366 !important;
    border-color: #25d366 !important;
    color: white !important;
}

.btn-whatsapp:hover {
    background-color: #128c7e !important;
    border-color: #128c7e !important;
    color: white !important;
}

.btn-whatsapp:focus {
    background-color: #25d366 !important;
    border-color: #25d366 !important;
    color: white !important;
    box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.25) !important;
}

/* Asegurar que los inputs sean interactivos */
.modal-personalizado input,
.modal-personalizado button,
.modal-personalizado textarea,
.modal-personalizado select {
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
}

.modal-personalizado .form-control {
    background-color: #fff !important;
    color: #495057 !important;
    cursor: text !important;
    border: 1px solid #ced4da !important;
}

.modal-personalizado .btn {
    cursor: pointer !important;
}
</style>

<script>
// Función para mostrar/ocultar contraseña
function togglePassword() {
    const passwordField = document.getElementById('passwordDisplay');
    const eyeIcon = document.getElementById('eyeIcon');
    
    if (passwordField.textContent === '••••••••••') {
        passwordField.textContent = '{{ cuenta.password }}';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        passwordField.textContent = '••••••••••';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

// Función para copiar al portapapeles
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Mostrar notificación de éxito
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 p-3';
        toast.style.zIndex = '1050';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header">
                    <i class="fas fa-check text-success me-2"></i>
                    <strong class="me-auto">Copiado</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    Texto copiado al portapapeles
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    });
}

// Función para abrir modal de venta
function abrirModalVenta() {
    // Establecer fecha mínima como hoy
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_vencimiento').min = today;
    
    // Mostrar modal personalizado
    document.getElementById('modalVenta').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Evitar scroll
}

// Función para cerrar modal personalizado
function cerrarModal() {
    document.getElementById('modalVenta').style.display = 'none';
    document.body.style.overflow = ''; // Restaurar scroll
}

// Función para enviar a WhatsApp
function enviarWhatsApp() {
    const nombre = document.getElementById('nombre_comprador').value;
    const whatsapp = document.getElementById('whatsapp_comprador').value;
    const fechaVencimiento = document.getElementById('fecha_vencimiento').value;
    
    if (!nombre || !whatsapp || !fechaVencimiento) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }
    
    // Crear mensaje de WhatsApp
    const mensaje = `¡Hola! 🎉

📱 *Datos de tu cuenta {{ cuenta.plataforma }}:*

🏷️ *Plataforma:* {{ cuenta.plataforma }}
📧 *Email:* {{ cuenta.email }}
🔑 *Contraseña:* {{ cuenta.password }}
📅 *Fecha de Creación:* {{ cuenta.fecha_creacion.strftime('%d/%m/%Y') if cuenta.fecha_creacion else 'N/A' }}
📅 *Vencimiento:* ${fechaVencimiento}

✅ *Tu cuenta está lista para usar*

📱 *ID de la cuenta:* #{{ cuenta.id }}

¡Disfruta de tu cuenta! 🎬

Si tienes alguna pregunta, no dudes en contactarnos.`;
    
    // Codificar el mensaje para URL
    const mensajeCodificado = encodeURIComponent(mensaje);
    
    // Crear URL de WhatsApp
    const numeroWhatsApp = whatsapp.replace('+', '');
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensajeCodificado}`;
    
    // Abrir WhatsApp en nueva pestaña
    window.open(urlWhatsApp, '_blank');
    
    // Mostrar confirmación
    alert(`WhatsApp abierto para ${nombre}\nNúmero: ${whatsapp}\n\nEl mensaje ya está pre-formateado y listo para enviar.`);
}

// Función para copiar mensaje de WhatsApp (cuando la cuenta ya está vendida)
function copiarMensajeWhatsApp() {
    const mensaje = `¡Hola! 🎉

📱 *Datos de tu cuenta {{ cuenta.plataforma }}:*

🏷️ *Plataforma:* {{ cuenta.plataforma }}
📧 *Email:* {{ cuenta.email }}
🔑 *Contraseña:* {{ cuenta.password }}
📅 *Fecha de Creación:* {{ cuenta.fecha_creacion.strftime('%d/%m/%Y') if cuenta.fecha_creacion else 'N/A' }}
📅 *Vencimiento:* {{ cuenta.fecha_vencimiento.strftime('%d/%m/%Y') if cuenta.fecha_vencimiento else 'N/A' }}

✅ *Tu cuenta está lista para usar*

📱 *ID de la cuenta:* #{{ cuenta.id }}

¡Disfruta de tu cuenta! 🎬

Si tienes alguna pregunta, no dudes en contactarnos.`;
    
    navigator.clipboard.writeText(mensaje).then(function() {
        alert('Mensaje de WhatsApp copiado al portapapeles');
    }).catch(function() {
        // Fallback para navegadores que no soportan clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = mensaje;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Mensaje de WhatsApp copiado al portapapeles');
    });
}

// Función para enviar WhatsApp al comprador (cuando la cuenta ya está vendida)
function enviarWhatsAppComprador() {
    // Verificar si hay información del comprador disponible
    const compradorInfo = document.querySelector('.bg-light.p-3.rounded');
    if (!compradorInfo) {
        alert('No hay información del comprador disponible');
        return;
    }
    
    // Extraer información del comprador del DOM
    const nombreElement = compradorInfo.querySelector('div:nth-child(1)');
    const whatsappElement = compradorInfo.querySelector('div:nth-child(2)');
    const vencimientoElement = compradorInfo.querySelector('div:nth-child(3)');
    
    if (!nombreElement || !whatsappElement || !vencimientoElement) {
        alert('Información del comprador incompleta');
        return;
    }
    
    const nombre = nombreElement.textContent.replace('Nombre:', '').trim();
    const whatsapp = whatsappElement.textContent.replace('WhatsApp:', '').trim();
    const vencimiento = vencimientoElement.textContent.replace('Vencimiento:', '').trim();
    
    // Verificar que no sea N/A
    if (nombre === 'N/A' || whatsapp === 'N/A' || vencimiento === 'N/A') {
        alert('La información del comprador no está completa');
        return;
    }
    
    const mensaje = `¡Hola ${nombre}! 🎉

📱 *Recordatorio de tu cuenta {{ cuenta.plataforma }}:*

🏷️ *Plataforma:* {{ cuenta.plataforma }}
📧 *Email:* {{ cuenta.email }}
🔑 *Contraseña:* {{ cuenta.password }}
📅 *Vencimiento:* ${vencimiento}

✅ *Tu cuenta sigue activa*

📱 *ID de la cuenta:* #{{ cuenta.id }}

¡Disfruta de tu cuenta! 🎬

Si tienes alguna pregunta, no dudes en contactarnos.`;
        
    // Codificar el mensaje para URL
    const mensajeCodificado = encodeURIComponent(mensaje);
    
    // Crear URL de WhatsApp
    const numeroWhatsApp = whatsapp.replace('+', '');
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensajeCodificado}`;
    
    // Abrir WhatsApp en nueva pestaña
    window.open(urlWhatsApp, '_blank');
}

// Función para recordar vencimiento
function recordarVencimiento() {
    // Verificar si hay información del comprador disponible
    const compradorInfo = document.querySelector('.bg-light.p-3.rounded');
    if (!compradorInfo) {
        alert('No hay información del comprador disponible');
        return;
    }
    
    // Extraer información del comprador del DOM
    const nombreElement = compradorInfo.querySelector('div:nth-child(1)');
    const whatsappElement = compradorInfo.querySelector('div:nth-child(2)');
    const vencimientoElement = compradorInfo.querySelector('div:nth-child(3)');
    
    if (!nombreElement || !whatsappElement || !vencimientoElement) {
        alert('Información del comprador incompleta');
        return;
    }
    
    const nombre = nombreElement.textContent.replace('Nombre:', '').trim();
    const whatsapp = whatsappElement.textContent.replace('WhatsApp:', '').trim();
    const vencimiento = vencimientoElement.textContent.replace('Vencimiento:', '').trim();
    
    // Verificar que no sea N/A
    if (nombre === 'N/A' || whatsapp === 'N/A' || vencimiento === 'N/A') {
        alert('La información del comprador no está completa');
        return;
    }
    
    const mensaje = `¡Hola ${nombre}! ⏰

📱 *Recordatorio de vencimiento de tu cuenta {{ cuenta.plataforma }}:*

🏷️ *Plataforma:* {{ cuenta.plataforma }}
📧 *Email:* {{ cuenta.email }}
📅 *Vencimiento:* ${vencimiento}

⚠️ *Tu cuenta vence pronto*

📱 *ID de la cuenta:* #{{ cuenta.id }}

¿Necesitas renovar tu cuenta? ¡Contáctanos! 📞`;
        
    // Codificar el mensaje para URL
    const mensajeCodificado = encodeURIComponent(mensaje);
    
    // Crear URL de WhatsApp
    const numeroWhatsApp = whatsapp.replace('+', '');
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensajeCodificado}`;
    
    // Abrir WhatsApp en nueva pestaña
    window.open(urlWhatsApp, '_blank');
}

// Función para confirmar eliminación
function confirmarEliminacion() {
    if (confirm('¿Estás seguro de que quieres eliminar esta cuenta? Esta acción no se puede deshacer.')) {
        document.getElementById('formEliminar').submit();
    }
}

// Establecer fecha mínima para fecha de vencimiento
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const fechaVencimiento = document.getElementById('fecha_vencimiento');
    if (fechaVencimiento) {
        fechaVencimiento.min = today;
    }
    
    // Configurar formulario de venta
    const formVenta = document.getElementById('formVenta');
    if (formVenta) {
        formVenta.addEventListener('submit', function(e) {
            const nombre = document.getElementById('nombre_comprador').value.trim();
            const whatsapp = document.getElementById('whatsapp_comprador').value.trim();
            const fecha = document.getElementById('fecha_vencimiento').value;
            
            if (!nombre || !whatsapp || !fecha) {
                e.preventDefault();
                alert('Por favor completa todos los campos obligatorios');
                return false;
            }
            
            // Validar formato de WhatsApp (debe incluir + y código de país)
            if (!whatsapp.startsWith('+')) {
                e.preventDefault();
                alert('El número de WhatsApp debe incluir el código del país (ej: +34612345678)');
                return false;
            }
            
            // Validar que la fecha de vencimiento sea futura
            const fechaVencimiento = new Date(fecha);
            const hoy = new Date();
            if (fechaVencimiento <= hoy) {
                e.preventDefault();
                alert('La fecha de vencimiento debe ser futura');
                return false;
            }
            
            if (confirm('¿Estás seguro de que quieres marcar esta cuenta como vendida?')) {
                // Cerrar modal antes de enviar
                cerrarModal();
                return true;
            } else {
                e.preventDefault();
                return false;
            }
        });
    }
});
</script>
{% endblock %}

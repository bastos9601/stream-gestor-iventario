{% extends "base.html" %}

{% block title %}{{ cuenta.plataforma }} - {{ cuenta.email }} - Gestor de Cuentas de Streaming{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-eye me-2"></i>
                    Detalles de la Cuenta
                </h1>
                <p class="lead text-muted">Informaci√≥n completa de la cuenta seleccionada</p>
            </div>
            <div class="btn-group" role="group">
                <a href="{{ url_for('listar_cuentas') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver
                </a>
                {% if current_user.es_admin %}
                <a href="{{ url_for('editar_cuenta', id=cuenta.id) }}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>
                    Editar
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Account Information -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Informaci√≥n de la Cuenta
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Plataforma</label>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tv text-primary me-2"></i>
                            <span class="fs-5">{{ cuenta.plataforma }}</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Estado</label>
                        <div>
                            {% if cuenta.estado == 'disponible' %}
                                <span class="badge badge-disponible fs-6">
                                    <i class="fas fa-check me-1"></i>Disponible
                                </span>
                            {% else %}
                                <span class="badge badge-vendida fs-6">
                                    <i class="fas fa-dollar-sign me-1"></i>Vendida
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Email</label>
                        <div class="d-flex align-items-center">
                            <code class="fs-6 me-2">{{ cuenta.email }}</code>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="copyToClipboard('{{ cuenta.email }}')"
                                    title="Copiar email">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Contrase√±a</label>
                        <div class="d-flex align-items-center">
                            <input type="password" class="form-control-plaintext me-2" 
                                   id="passwordDisplay" value="{{ cuenta.password }}" readonly>
                            <button class="btn btn-sm btn-outline-primary me-2" 
                                    onclick="togglePasswordDisplay()"
                                    title="Mostrar/Ocultar contrase√±a">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="copyToClipboard('{{ cuenta.password }}')"
                                    title="Copiar contrase√±a">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Precio</label>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success fs-5">${{ "%.2f"|format(cuenta.precio) }}</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha de Compra</label>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar text-info me-2"></i>
                            <span>{{ cuenta.fecha_compra.strftime('%d/%m/%Y') }}</span>
                        </div>
                    </div>
                    
                    {% if cuenta.fecha_venta %}
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha de Venta</label>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-check text-success me-2"></i>
                            <span>{{ cuenta.fecha_venta.strftime('%d/%m/%Y') }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if cuenta.notas %}
                    <div class="col-12">
                        <label class="form-label fw-bold">Notas</label>
                        <div class="p-3 bg-light rounded">
                            <i class="fas fa-sticky-note text-warning me-2"></i>
                            {{ cuenta.notas }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">ID de la Cuenta</label>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary fs-6">#{{ cuenta.id }}</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha de Creaci√≥n</label>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock text-muted me-2"></i>
                            <span>{{ cuenta.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions and Status -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Acciones
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if current_user.es_admin %}
                        {% if cuenta.estado == 'disponible' %}
                            <button type="button" class="btn btn-success w-100" onclick="abrirModalVenta()">
                                <i class="fas fa-dollar-sign me-2"></i>
                                Marcar como Vendida
                            </button>
                        {% else %}
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                Esta cuenta ya fue vendida
                            </div>
                            {% if cuenta.nombre_comprador %}
                            <div class="mt-3">
                                <h6 class="text-muted">Informaci√≥n del Comprador:</h6>
                                <p class="mb-1"><strong>Nombre:</strong> {{ cuenta.nombre_comprador }}</p>
                                <p class="mb-1"><strong>WhatsApp:</strong> {{ cuenta.whatsapp_comprador }}</p>
                                <p class="mb-1"><strong>Vencimiento:</strong> 
                                    {% if cuenta.fecha_vencimiento %}
                                        {{ cuenta.fecha_vencimiento.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </p>
                                <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="copiarMensajeWhatsApp({{ cuenta.id }})">
                                    <i class="fas fa-copy me-2"></i>
                                    Copiar Mensaje WhatsApp
                                </button>
                                <button type="button" class="btn btn-whatsapp btn-sm w-100 mb-2" onclick="enviarWhatsAppVendida({{ cuenta.id }})">
                                    <i class="fab fa-whatsapp me-2"></i>
                                    Enviar a WhatsApp
                                </button>
                                <button type="button" class="btn btn-warning btn-sm w-100 mb-2" onclick="recordarVencimiento({{ cuenta.id }})">
                                    <i class="fas fa-clock me-2"></i>
                                    Recordar Vencimiento
                                </button>
                            </div>
                            {% endif %}
                        {% endif %}
                        
                        <a href="{{ url_for('editar_cuenta', id=cuenta.id) }}" class="btn btn-warning">
                            <i class="fas fa-edit me-2"></i>
                            Editar Cuenta
                        </a>
                        
                        <form method="POST" action="{{ url_for('eliminar_cuenta', id=cuenta.id) }}" 
                              onsubmit="return confirmDelete('¬øEst√°s seguro de que quieres eliminar esta cuenta? Esta acci√≥n no se puede deshacer.')">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-trash me-2"></i>
                                Eliminar Cuenta
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Usuario Normal</strong><br>
                            Solo puedes ver y agregar cuentas
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Quick Info -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Informaci√≥n R√°pida
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ cuenta.precio|round(2) }}</h4>
                        <small class="text-muted">Precio</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-{% if cuenta.estado == 'disponible' %}success{% else %}warning{% endif %}">
                            {{ cuenta.estado|title }}
                        </h4>
                        <small class="text-muted">Estado</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Related Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-link me-2"></i>
                    Acciones Relacionadas
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="{{ url_for('listar_cuentas', plataforma=cuenta.plataforma) }}" 
                           class="btn btn-outline-primary w-100">
                            <i class="fas fa-tv me-2"></i>
                            Ver m√°s cuentas de {{ cuenta.plataforma }}
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('listar_cuentas', estado=cuenta.estado) }}" 
                           class="btn btn-outline-info w-100">
                            <i class="fas fa-filter me-2"></i>
                            Ver cuentas {{ cuenta.estado }}s
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('nueva_cuenta') }}" 
                           class="btn btn-outline-success w-100">
                            <i class="fas fa-plus me-2"></i>
                            Agregar nueva cuenta
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Venta PERSONALIZADO Y FUNCIONAL -->
<div id="modalVenta" class="modal-personalizado" style="display: none;">
    <div class="modal-overlay" onclick="cerrarModal()"></div>
    <div class="modal-contenido">
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="fas fa-dollar-sign me-2"></i>
                Vender Cuenta
            </h5>
            <button type="button" class="btn-cerrar" onclick="cerrarModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('vender_cuenta', id=cuenta.id) }}" id="formVenta">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="nombre_comprador" class="form-label fw-bold">
                                <i class="fas fa-user me-2 text-primary"></i>
                                Nombre del Comprador *
                            </label>
                            <input type="text" class="form-control form-control-lg" 
                                   id="nombre_comprador" name="nombre_comprador" 
                                   required placeholder="Ingresa el nombre completo"
                                   autocomplete="off">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="whatsapp_comprador" class="form-label fw-bold">
                                <i class="fab fa-whatsapp me-2 text-success"></i>
                                N√∫mero de WhatsApp *
                            </label>
                            <input type="tel" class="form-control form-control-lg" 
                                   id="whatsapp_comprador" name="whatsapp_comprador" 
                                   required placeholder="+34612345678"
                                   autocomplete="off">
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Incluye el c√≥digo del pa√≠s
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="fecha_vencimiento" class="form-label fw-bold">
                        <i class="fas fa-calendar-alt me-2 text-warning"></i>
                        Fecha de Vencimiento *
                    </label>
                    <input type="date" class="form-control form-control-lg" 
                           id="fecha_vencimiento" name="fecha_vencimiento" 
                           required>
                    <div class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        La cuenta debe vencer despu√©s de la fecha de compra
                    </div>
                </div>
                
                <div class="alert alert-info border-0">
                    <div class="row">
                        <div class="col-md-4">
                            <strong><i class="fas fa-tv me-2"></i>Plataforma:</strong><br>
                            <span class="badge bg-primary fs-6">{{ cuenta.plataforma }}</span>
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-envelope me-2"></i>Email:</strong><br>
                            <code class="fs-6">{{ cuenta.email }}</code>
                        </div>
                        <div class="col-md-4">
                            <strong><i class="fas fa-dollar-sign me-2"></i>Precio:</strong><br>
                            <span class="badge bg-success fs-6">${{ "%.2f"|format(cuenta.precio) }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-lg" onclick="cerrarModal()">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-whatsapp btn-lg me-2" onclick="enviarWhatsApp()">
                    <i class="fab fa-whatsapp me-2"></i>
                    Enviar a WhatsApp
                </button>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-check me-2"></i>
                    Confirmar Venta
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
/* CSS para Modal Personalizado */
.modal-personalizado {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1;
}

.modal-contenido {
    position: relative;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 2;
}

.modal-header {
    background-color: #198754;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.btn-cerrar {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-cerrar:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

/* Asegurar que los inputs sean interactivos */
.modal-personalizado input,
.modal-personalizado button,
.modal-personalizado textarea,
.modal-personalizado select {
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
}

.modal-personalizado .form-control {
    background-color: #fff !important;
    color: #495057 !important;
    cursor: text !important;
    border: 1px solid #ced4da !important;
}

.modal-personalizado .btn {
    cursor: pointer !important;
}

/* Bot√≥n de WhatsApp */
.btn-whatsapp {
    background-color: #25d366 !important;
    border-color: #25d366 !important;
    color: white !important;
}

.btn-whatsapp:hover {
    background-color: #128c7e !important;
    border-color: #128c7e !important;
    color: white !important;
}

.btn-whatsapp:focus {
    background-color: #25d366 !important;
    border-color: #25d366 !important;
    color: white !important;
    box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.25) !important;
}
</style>

<script>
// Toggle password visibility
function togglePasswordDisplay() {
    const passwordInput = document.getElementById('passwordDisplay');
    const toggleIcon = document.getElementById('passwordToggleIcon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    }
}

// Enhanced copy to clipboard with better feedback
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success toast
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 p-3';
        toast.style.zIndex = '1050';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <strong class="me-auto">¬°Copiado!</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>
                    ${text.length > 30 ? text.substring(0, 30) + '...' : text} copiado al portapapeles
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 3000);
    }).catch(function(err) {
        console.error('Error al copiar: ', err);
        alert('Error al copiar al portapapeles');
    });
}

// Auto-hide password after 30 seconds for security
setTimeout(function() {
    const passwordInput = document.getElementById('passwordDisplay');
    if (passwordInput && passwordInput.type === 'text') {
        passwordInput.type = 'password';
        const toggleIcon = document.getElementById('passwordToggleIcon');
        if (toggleIcon) {
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }
}, 30000);

// Funci√≥n para copiar mensaje de WhatsApp
function copiarMensajeWhatsApp(cuentaId) {
    fetch(`/api/cuenta/${cuentaId}/mensaje-whatsapp`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Copiar mensaje al portapapeles
            copyToClipboard(data.mensaje);
            
            // Mostrar informaci√≥n del comprador
            const mensaje = `Mensaje copiado para ${data.nombre_comprador}\nWhatsApp: ${data.whatsapp}\n\nEl mensaje ya est√° en tu portapapeles. Puedes pegarlo directamente en WhatsApp.`;
            alert(mensaje);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al obtener el mensaje de WhatsApp');
        });
}

// Funci√≥n para validar y enviar el formulario de venta
function validarFormularioVenta(e) {
    e.preventDefault();
    
    const nombre = document.getElementById('nombre_comprador').value.trim();
    const whatsapp = document.getElementById('whatsapp_comprador').value.trim();
    const fecha = document.getElementById('fecha_vencimiento').value;
    
    console.log('Validando formulario:', { nombre, whatsapp, fecha });
    
    if (!nombre || !whatsapp || !fecha) {
        alert('Por favor completa todos los campos obligatorios');
        return false;
    }
    
    // Validar formato de WhatsApp (debe incluir + y c√≥digo de pa√≠s)
    if (!whatsapp.startsWith('+')) {
        alert('El n√∫mero de WhatsApp debe incluir el c√≥digo del pa√≠s (ej: +34612345678)');
        return false;
    }
    
    // Validar que la fecha de vencimiento sea futura
    const fechaVencimiento = new Date(fecha);
    const hoy = new Date();
    if (fechaVencimiento <= hoy) {
        alert('La fecha de vencimiento debe ser futura');
        return false;
    }
    
    if (confirm('¬øEst√°s seguro de que quieres marcar esta cuenta como vendida?')) {
        console.log('Enviando formulario...');
        document.getElementById('formVenta').submit();
    }
}

// Funci√≥n simple para enviar formulario
function enviarFormulario() {
    console.log('Enviando formulario...');
    
    const nombre = document.getElementById('nombre_comprador').value.trim();
    const whatsapp = document.getElementById('whatsapp_comprador').value.trim();
    const fecha = document.getElementById('fecha_vencimiento').value;
    
    if (!nombre || !whatsapp || !fecha) {
        alert('Por favor completa todos los campos obligatorios');
        return;
    }
    
    if (confirm('¬øEst√°s seguro de que quieres marcar esta cuenta como vendida?')) {
        document.getElementById('formVenta').submit();
    }
}

// Funci√≥n de debug para el modal
function debugModal() {
    console.log('=== DEBUG MODAL ===');
    console.log('Bootstrap:', typeof bootstrap !== 'undefined' ? 'Disponible' : 'NO disponible');
    console.log('Modal element:', document.getElementById('modalVenta'));
    console.log('Form element:', document.getElementById('formVenta'));
    console.log('Nombre input:', document.getElementById('nombre_comprador'));
    console.log('WhatsApp input:', document.getElementById('whatsapp_comprador'));
    console.log('Fecha input:', document.getElementById('fecha_vencimiento'));
    
    // Probar abrir modal manualmente
    try {
        const modalEl = document.getElementById('modalVenta');
        if (modalEl && typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            console.log('Modal abierto manualmente');
        }
    } catch (error) {
        console.error('Error al abrir modal:', error);
    }
}

// Funci√≥n para probar la interactividad de los campos
function probarInteractividad() {
    console.log('=== PROBANDO INTERACTIVIDAD ===');
    
    const nombreInput = document.getElementById('nombre_comprador');
    const whatsappInput = document.getElementById('whatsapp_comprador');
    const fechaInput = document.getElementById('fecha_vencimiento');
    
    if (nombreInput) {
        console.log('Probando campo nombre...');
        nombreInput.focus();
        nombreInput.value = 'TEST';
        nombreInput.style.backgroundColor = 'yellow';
        console.log('Campo nombre modificado');
    }
    
    if (whatsappInput) {
        console.log('Probando campo WhatsApp...');
        whatsappInput.focus();
        whatsappInput.value = '+1234567890';
        whatsappInput.style.backgroundColor = 'lightgreen';
        console.log('Campo WhatsApp modificado');
    }
    
    if (fechaInput) {
        console.log('Probando campo fecha...');
        fechaInput.focus();
        fechaInput.value = '2025-12-31';
        fechaInput.style.backgroundColor = 'lightblue';
        console.log('Campo fecha modificado');
    }
}

// Funci√≥n de emergencia para forzar interactividad
function forzarInteractividad() {
    console.log('=== FORZANDO INTERACTIVIDAD DE EMERGENCIA ===');
    
    const inputs = document.querySelectorAll('#modalVenta input');
    console.log('Inputs encontrados:', inputs.length);
    
    inputs.forEach((input, index) => {
        console.log(`Forzando input ${index + 1}:`, input);
        
        // Remover todos los atributos restrictivos
        input.removeAttribute('disabled');
        input.removeAttribute('readonly');
        input.removeAttribute('style');
        
        // Forzar estilos inline
        input.style.cssText = `
            pointer-events: auto !important;
            user-select: text !important;
            background-color: #fff !important;
            color: #495057 !important;
            cursor: text !important;
            position: relative !important;
            z-index: 10000 !important;
            border: 2px solid red !important;
        `;
        
        // Agregar event listeners
        input.addEventListener('click', function(e) {
            e.stopPropagation();
            this.focus();
            console.log('Input clickeado:', this);
        });
        
        input.addEventListener('focus', function() {
            console.log('Input enfocado:', this);
        });
        
        input.addEventListener('input', function() {
            console.log('Input modificado:', this.value);
        });
        
        // Hacer el input editable
        input.contentEditable = true;
        input.spellcheck = false;
        
        console.log(`Input ${index + 1} forzado:`, input);
    });
    
    // Intentar enfocar el primer input
    if (inputs.length > 0) {
        setTimeout(() => {
            inputs[0].focus();
            inputs[0].click();
            console.log('Primer input enfocado y clickeado');
        }, 500);
    }
}

// Funci√≥n de diagn√≥stico CSS completo
function diagnosticarModal() {
    console.log('=== DIAGN√ìSTICO CSS COMPLETO ===');
    
    const modal = document.getElementById('modalVenta');
    if (!modal) {
        console.error('‚ùå Modal no encontrado');
        return;
    }
    
    console.log('‚úÖ Modal encontrado:', modal);
    
    // Verificar inputs
    const inputs = document.querySelectorAll('#modalVenta input');
    console.log(`üìù Inputs encontrados: ${inputs.length}`);
    
    inputs.forEach((input, index) => {
        console.log(`\n--- INPUT ${index + 1} ---`);
        console.log('Elemento:', input);
        
        // Verificar atributos
        const disabled = input.hasAttribute('disabled');
        const readonly = input.hasAttribute('readonly');
        console.log(`‚ùå Disabled: ${disabled}`);
        console.log(`‚ùå Readonly: ${readonly}`);
        
        // Verificar estilos computados
        const styles = window.getComputedStyle(input);
        console.log(`üé® Background: ${styles.backgroundColor}`);
        console.log(`üëÜ Pointer-events: ${styles.pointerEvents}`);
        console.log(`üë§ User-select: ${styles.userSelect}`);
        console.log(`üìç Position: ${styles.position}`);
        console.log(`üìå Z-index: ${styles.zIndex}`);
        console.log(`üéØ Cursor: ${styles.cursor}`);
        
        // Verificar si est√° bloqueado
        if (disabled || readonly) {
            console.log('üö´ INPUT BLOQUEADO POR ATRIBUTOS');
        }
        if (styles.pointerEvents === 'none') {
            console.log('üö´ INPUT BLOQUEADO POR POINTER-EVENTS');
        }
        if (styles.userSelect === 'none') {
            console.log('üö´ INPUT BLOQUEADO POR USER-SELECT');
        }
    });
    
    // Verificar modal backdrop
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        const backdropStyles = window.getComputedStyle(backdrop);
        console.log(`\n--- MODAL BACKDROP ---`);
        console.log('Elemento:', backdrop);
        console.log(`üìå Z-index: ${backdropStyles.zIndex}`);
        console.log(`üìç Position: ${backdropStyles.position}`);
    }
    
    // Verificar elementos superpuestos
    console.log(`\n--- VERIFICANDO ELEMENTOS SUPERPUESTOS ---`);
    const modalRect = modal.getBoundingClientRect();
    inputs.forEach((input, index) => {
        const inputRect = input.getBoundingClientRect();
        const elementsAtPoint = document.elementsFromPoint(
            inputRect.left + inputRect.width / 2,
            inputRect.top + inputRect.height / 2
        );
        
        console.log(`\nElementos en el punto del Input ${index + 1}:`);
        elementsAtPoint.forEach((el, i) => {
            if (el !== input && el !== modal) {
                console.log(`  ${i + 1}. ${el.tagName} - ${el.className || 'sin clase'}`);
            }
        });
    });
    
    console.log('\n=== FIN DEL DIAGN√ìSTICO ===');
}

// Configuraci√≥n del Modal Personalizado
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado, configurando modal personalizado...');
    
    // Establecer fecha m√≠nima para vencimiento
    const fechaVencimiento = document.getElementById('fecha_vencimiento');
    if (fechaVencimiento) {
        const hoy = new Date();
        const fechaMinima = hoy.toISOString().split('T')[0];
        fechaVencimiento.min = fechaMinima;
        console.log('Fecha m√≠nima establecida:', fechaMinima);
    }
    
    // Configurar formulario
    const formVenta = document.getElementById('formVenta');
    if (formVenta) {
        formVenta.addEventListener('submit', validarFormularioVenta);
        console.log('Formulario configurado');
    }
});

// Funci√≥n para abrir el modal personalizado
function abrirModalVenta() {
    console.log('Abriendo modal personalizado...');
    const modal = document.getElementById('modalVenta');
    if (modal) {
        modal.style.display = 'flex';
        
        // Limpiar campos
        setTimeout(() => {
            const inputs = document.querySelectorAll('#modalVenta input');
            inputs.forEach((input, index) => {
                input.value = '';
                input.disabled = false;
                input.readOnly = false;
                console.log(`Campo ${index + 1} habilitado:`, input);
            });
            
            // Enfocar primer campo
            if (inputs.length > 0) {
                inputs[0].focus();
                console.log('Primer campo enfocado');
            }
        }, 100);
    }
}

// Funci√≥n para cerrar el modal personalizado
function cerrarModal() {
    console.log('Cerrando modal personalizado...');
    const modal = document.getElementById('modalVenta');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Funci√≥n para enviar datos a WhatsApp
function enviarWhatsApp() {
    console.log('Enviando a WhatsApp...');
    
    // Obtener datos del formulario
    const nombre = document.getElementById('nombre_comprador').value.trim();
    const whatsapp = document.getElementById('whatsapp_comprador').value.trim();
    const fecha = document.getElementById('fecha_vencimiento').value;
    
    // Validar que est√©n completos los campos
    if (!nombre || !whatsapp || !fecha) {
        alert('Por favor completa todos los campos antes de enviar a WhatsApp');
        return;
    }
    
    // Validar formato de WhatsApp
    if (!whatsapp.startsWith('+')) {
        alert('El n√∫mero de WhatsApp debe incluir el c√≥digo del pa√≠s (ej: +34612345678)');
        return;
    }
    
    // Obtener datos de la cuenta
    const plataforma = '{{ cuenta.plataforma }}';
    const email = '{{ cuenta.email }}';
    const password = '{{ cuenta.password }}';
    const precio = '{{ "%.2f"|format(cuenta.precio) }}';
    
    // Formatear fecha de vencimiento
    const fechaVencimiento = new Date(fecha);
    const fechaFormateada = fechaVencimiento.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
    
    // Crear mensaje de WhatsApp
    const mensaje = `¬°Hola ${nombre}! üéâ

üì± *Datos de tu cuenta ${plataforma}:*

üè∑Ô∏è *Plataforma:* ${plataforma}
üìß *Email:* ${email}
üîë *Contrase√±a:* ${password}
üí∞ *Precio:* $${precio}
üìÖ *Vencimiento:* ${fechaFormateada}

‚úÖ *Tu cuenta est√° lista para usar*

üì± *ID de la cuenta:* #{{ cuenta.id }}

¬°Disfruta de tu cuenta! üé¨

Si tienes alguna pregunta, no dudes en contactarnos.`;

    // Codificar el mensaje para URL
    const mensajeCodificado = encodeURIComponent(mensaje);
    
    // Crear URL de WhatsApp
    const numeroWhatsApp = whatsapp.replace('+', '');
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensajeCodificado}`;
    
    // Abrir WhatsApp en nueva pesta√±a
    window.open(urlWhatsApp, '_blank');
    
    console.log('WhatsApp abierto con mensaje:', mensaje);
    
    // Mostrar confirmaci√≥n
    alert(`WhatsApp abierto para ${nombre}\nN√∫mero: ${whatsapp}\n\nEl mensaje ya est√° pre-formateado y listo para enviar.`);
}

// Funci√≥n para enviar WhatsApp de cuenta ya vendida
function enviarWhatsAppVendida(cuentaId) {
    console.log('Enviando WhatsApp de cuenta vendida:', cuentaId);
    
    // Obtener datos de la cuenta vendida
    const plataforma = '{{ cuenta.plataforma }}';
    const email = '{{ cuenta.email }}';
    const password = '{{ cuenta.password }}';
    const precio = '{{ "%.2f"|format(cuenta.precio) }}';
    const nombreComprador = '{{ cuenta.nombre_comprador }}';
    const whatsappComprador = '{{ cuenta.whatsapp_comprador }}';
    const fechaVencimiento = '{{ cuenta.fecha_vencimiento.strftime("%d/%m/%Y") if cuenta.fecha_vencimiento else "N/A" }}';
    
    // Crear mensaje de WhatsApp
    const mensaje = `¬°Hola ${nombreComprador}! üéâ

üì± *Datos de tu cuenta ${plataforma}:*

üè∑Ô∏è *Plataforma:* ${plataforma}
üìß *Email:* ${email}
üîë *Contrase√±a:* ${password}
üí∞ *Precio:* $${precio}
üìÖ *Vencimiento:* ${fechaVencimiento}

‚úÖ *Tu cuenta est√° lista para usar*

üì± *ID de la cuenta:* #{{ cuenta.id }}

¬°Disfruta de tu cuenta! üé¨

Si tienes alguna pregunta, no dudes en contactarnos.`;

    // Codificar el mensaje para URL
    const mensajeCodificado = encodeURIComponent(mensaje);
    
    // Crear URL de WhatsApp
    const numeroWhatsApp = whatsappComprador.replace('+', '');
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensajeCodificado}`;
    
    // Abrir WhatsApp en nueva pesta√±a
    window.open(urlWhatsApp, '_blank');
    
    console.log('WhatsApp abierto para cuenta vendida:', mensaje);
    
    // Mostrar confirmaci√≥n
    alert(`WhatsApp abierto para ${nombreComprador}\nN√∫mero: ${whatsappComprador}\n\nEl mensaje ya est√° pre-formateado y listo para enviar.`);
}

// Funci√≥n para recordar vencimiento de cuenta
function recordarVencimiento(cuentaId) {
    console.log('Recordando vencimiento de cuenta:', cuentaId);
    
    // Obtener datos de la cuenta vendida
    const plataforma = '{{ cuenta.plataforma }}';
    const email = '{{ cuenta.email }}';
    const nombreComprador = '{{ cuenta.nombre_comprador }}';
    const whatsappComprador = '{{ cuenta.whatsapp_comprador }}';
    const fechaVencimiento = '{{ cuenta.fecha_vencimiento.strftime("%d/%m/%Y") if cuenta.fecha_vencimiento else "N/A" }}';
    
    // Verificar si la cuenta est√° vencida
    const fechaVenc = '{{ cuenta.fecha_vencimiento.isoformat() if cuenta.fecha_vencimiento else "" }}';
    const hoy = new Date();
    const vencimiento = new Date(fechaVenc);
    const diasRestantes = Math.ceil((vencimiento - hoy) / (1000 * 60 * 60 * 24));
    
    let mensaje = '';
    let titulo = '';
    
    if (diasRestantes > 0) {
        // Cuenta a√∫n v√°lida
        titulo = 'Recordatorio de Vencimiento';
        mensaje = `¬°Hola ${nombreComprador}! ‚è∞

üì± *Recordatorio de tu cuenta ${plataforma}:*

üè∑Ô∏è *Plataforma:* ${plataforma}
üìß *Email:* ${email}
üìÖ *Vencimiento:* ${fechaVencimiento}

‚ö†Ô∏è *Tu cuenta vence en ${diasRestantes} d√≠a${diasRestantes === 1 ? '' : 's'}*

üí° *Recomendaciones:*
‚Ä¢ Renueva tu cuenta antes del vencimiento
‚Ä¢ Evita interrupciones en tu servicio
‚Ä¢ Mant√©n acceso continuo a ${plataforma}

üîÑ *¬øQuieres renovar tu cuenta?*
Cont√°ctanos para m√°s informaci√≥n.

üì± *ID de la cuenta:* #{{ cuenta.id }}

¬°Gracias por tu confianza! üôè`;
        
    } else {
        // Cuenta vencida
        titulo = 'Cuenta Vencida';
        mensaje = `¬°Hola ${nombreComprador}! ‚ö†Ô∏è

üì± *Tu cuenta ${plataforma} ha vencido:*

üè∑Ô∏è *Plataforma:* ${plataforma}
üìß *Email:* ${email}
üìÖ *Vencimiento:* ${fechaVencimiento}
‚ùå *Estado:* VENCIDA

üö® *Tu cuenta ya no est√° activa*

üí° *¬øQu√© puedes hacer?*
‚Ä¢ Renovar tu cuenta inmediatamente
‚Ä¢ Recuperar acceso a ${plataforma}
‚Ä¢ Evitar p√©rdida de datos/configuraciones

üîÑ *Renovaci√≥n disponible:*
Cont√°ctanos para reactivar tu cuenta.

üì± *ID de la cuenta:* #{{ cuenta.id }}

¬°No pierdas tu acceso! üöÄ`;
    }
    
    // Codificar el mensaje para URL
    const mensajeCodificado = encodeURIComponent(mensaje);
    
    // Crear URL de WhatsApp
    const numeroWhatsApp = whatsappComprador.replace('+', '');
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensajeCodificado}`;
    
    // Abrir WhatsApp en nueva pesta√±a
    window.open(urlWhatsApp, '_blank');
    
    console.log('WhatsApp abierto para recordatorio:', mensaje);
    
    // Mostrar confirmaci√≥n
    alert(`${titulo}\n\nWhatsApp abierto para ${nombreComprador}\nN√∫mero: ${whatsappComprador}\n\nEl mensaje de recordatorio est√° listo para enviar.`);
}
</script>
{% endblock %}
